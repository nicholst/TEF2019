---
title: "Playing With Binomial Mixed Models"
author: "T Nichols"
date: "04/03/2019"
output: html_document
---

```{r presetup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Simplistic Demo of Modelling Count Data with Mixed Models

```{r setup, include=FALSE}
require(lme4)
```

This parameters reflect Dorothy's toy set up...
```{r Parameters }
Nuni=100
Nctx=4
Uni=rep(1:Nuni,each=Nctx)
# Now have systematic variation in Number of students
Nstud=rep(round(seq(25,1000,len=Nuni)),each=Nctx)
Context=rep(1:Nctx,Nuni)
# Will need these for later modelling
Context.f=factor(Context)
Uni.f=factor(Uni)
```

Now lets create some fake truth... a strong context effect... *no* uni effect, *except* we have a uni-dependent context effect... odd unis are worse at context 4, even unis are better at context r.
```{r GroundTruth }
Logit=function(p)log(p/(1-p))
InvLogit=function(x)exp(x)/(1+exp(x))
# Add uni-specific context effect at every 5'th uni
Succ=InvLogit(rep(Logit(seq(0.3,0.7,len=4)),Nuni)+Logit(rep(c(0.5,0.5,0.5,  0.4  ,0.5,0.5,0.5,  0.6  ),Nuni/2)))
# Adjust 0.3,0.7 to change context effect, change 0.4 and 0.6 to alter context-4 uni-odd/even effect
# The more similar the less the effect (e.g. 0.5,0.5 would be no effect)

plot(Uni,Succ,col=1:4,ylim=c(0,1),
      main="True success probabilities",
      xlab="University",ylab="Probability");
legend(x='topleft',legend=c("Ctx 1","Ctx 2","Ctx 3","Ctx 4"),pch=1,col=1:4)

# One realisation of data...
Y=rbinom(n=Nuni*Nctx,size = Nstud,prob = Succ)

plot(Uni,Y/Nstud,col=1:4,ylim=c(0,1),
      main="Estimated success probabilities",
      xlab="University",ylab="Probability");
legend(x='topleft',legend=c("Ctx 1","Ctx 2","Ctx 3","Ctx 4"),pch=1,col=1:4)

```

So, to be concrete, in probabilities, this is the effect in the data
```{r CtxComparison}
Succ[1:4]
Succ[5:8]
Succ[8]-Succ[4]
```

Or, in other words, even unis pass context 4 students at a rate 17 percentage points over odd unis.

Useful also to see this in Logit scale:
```{r CtxComparisonLog}
Logit(Succ[1:4])
Logit(Succ[5:8])
```

This fixed effects model is now correct, *except* for the odd-even Uni effect on context 4

## Fixed Effects Model
```{r FitGLM}
mod = glm(cbind(Y,Nstud-Y) ~ -1 + Context.f, family="binomial")
print(mod)
```
These context effects are similar but not so close to the true Logit scale values.  (Note I've used the -1 to let `Context.f` estimate the mean and give 4 interpretable values, instead of an intercept and 3 relative `Context.f` estimates.)

Now let's see about residuals
```{r GLM.ResidualAnalysis}
Res=residuals(mod,type="pearson",scaled=TRUE)
plot(Nstud,Res,col=1:4,
      main="Residuals - Fixed Effects",
      xlab="Number students in context/uni",ylab="Standardised Residual");
legend(x='topleft',legend=c("Ctx 1","Ctx 2","Ctx 3","Ctx 4"),pch=1,col=1:4)
abline(h=0);abline(h=c(-1.96,1.96),lty=3)
#qqnorm(Res,col=1:4);abline(0,1)
```

Having now plotted the Univesities by size (precisely, the number of students per context), we can see that the size of the Z-score is driven not just by the odd-even effect, but sample size in each cell.

